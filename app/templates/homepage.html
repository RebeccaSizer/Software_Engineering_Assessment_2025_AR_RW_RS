<!DOCTYPE html>
<html>
<head>
    <!--
    =============================================================================
    Template: homepage.html

    Purpose:
    --------
    User interface for creating, adding to, or querying a local variant database
    from clinically generated variant files (e.g. VCFs).

    Intended Users:
    ---------------
    Clinical Scientists / Clinical Bioinformaticians working with
    validated variant call data.

    Notes:
    ------
    - This template is rendered by Flask using Jinja2
    - All file handling, validation, and persistence must be handled server-side
      to ensure data integrity and clinical governance compliance
    =============================================================================
    -->
    <title>Upload or Select Database</title>
    <style>
        /* ---------------------------------------------------------------------
           Tiny spinner used inside the submit button to indicate that the app
           is processing. Processing can take several minutes during which the
           User can mistake the app is dysfunctional. The spinner deters this.
           --------------------------------------------------------------------- */
        .spinner-tiny {
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-top-color: #24bf96;  /* SAME as background */
            border-radius: 50%;
            width: 12px;
            height: 12px;
            animation: spin 0.6s linear infinite;
            display: none;
        }

        /* Spinner animation */
        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* ---------------------------------------------------------------------
           Loading message shown during database generation.
           Similar to the Spinner, this helps reassure Users that a database is
           being generated from the data that they uploaded.
           --------------------------------------------------------------------- */
        .loading-message {
            display: none;
            margin-top: 10px;
            color: #7A1F5C;
            font-size: 14px;
            font-style: italic;
            font-weight: bold;
            opacity: 0.9;
        }

        /* ---------------------------------------------------------------------
           Flash messages used by Flask to report success/failure states to
           Users such as invalid file formats, database creation errors, etc.
           --------------------------------------------------------------------- */
        .flash-messages li {
            font-size: 14px;
            color: #7A1F5C;
            font-weight: bold;
        }

        /* ---------------------------------------------------------------------
           Colour and design of general webpage components including
           background, text and buttons .
           --------------------------------------------------------------------- */
        body {
            background-color: #24bf96;
            color: white;
            font-family: "Nirmala UI", sans-serif;
            padding: 20px;
        }
        select, input, button {
            font-family: "Nirmala UI", sans-serif;
            color: black;
            margin: 5px;
            padding: 5px;
        }
    </style>
</head>

<body>
    <!-- Application header -->
    <h1>ðŸŒŠðŸ§¬ SEA: The Variant Database Query Tool</h1>

    <!--
    ---------------------------------------------------------------------
    Flask flash messages:
    Used to report errors, warnings and successful processes during the
    generation of a database, to the Users.
    ---------------------------------------------------------------------
    -->
    {% with messages = get_flashed_messages() %}
      {% if messages %}
        <ul class="flash-messages">
          {% for message in messages %}
            <li>{{ message }}</li>
          {% endfor %}
        </ul>
      {% endif %}
    {% endwith %}

    <!-- =====================================================================
         CREATING OR ADDING TO THE DATABASE
         ===================================================================== -->
    <h2>Create or Add to a Database</h2>

    <form id="make_database" method="POST" enctype="multipart/form-data">

        <!--
        Hidden field used to denote the process of adding a variant to a
        database. 'add_variant' is used in app.py to determine which
        functions and commands are executed when the User tries to create
        or add to a database.
        -->
        <input type="hidden" name="form_type" value="add_variant">

         <!--
        Variant input:
        --------------
        - VCF and CSV variant files are accepted by flask and app.py.
        - Multiple files can be selected, enabling batch loading.
        -->
        <label for="vcf">Select variant files:</label>
        <input type="file" name="variant_files" id="vcf" accept=".vcf, .csv" multiple required>

        <!--
        Database selection:
        -------------------
        Users are able to:
        - Enter a name for the database that they want to create
        - Select an existing database from a dropdown menu

        Autocomplete is used to help reduce naming errors.

        'db_file' is processed in app.py to reflect the name of the
        database entered by the User. If the User selects a database
        from the dropdown menu, 'existing_db' is processed instead.
        -->
        <label for="db_file">Choose or enter a database file name:</label>
        <input list="existing_db" name="db_file" id="db_file" class="form-control">
        {% if databases %}
        <datalist id="existing_db">
            {% for db in databases %}
            <option value="{{ db }}">{{ db }}</option>
            {% endfor %}
        </datalist>
        {% endif %}

        <!-- Submit button with inline spinner -->
        <button type="submit" class="btn btn-primary mt-3">
            Create Database
            <span id="buttonSpinner" class="spinner-tiny"></span>
        </button>
    </form>

    <!--
    Loading message area:
    ---------------------
    "Loading database. Please wait..." appears in this section
    while app.py creates/updates the chosen database.
    -->
    <div id="loadingArea" style="margin-top: 10px;">
        <div id="loadingMsg" class="loading-message">
            Loading database. Please wait...
        </div>
    </div>

    <hr>

    <!-- =====================================================================
         QUERY EXISTING DATABASES
         ===================================================================== -->
    <h2>Query an Existing Database</h2>
    {% if databases %}
        <form method="POST">

            <!--
            Hidden field used to denote the process of querying and existing
            database. 'open_db' is used in app.py to determine which functions
            and commands are executed when the User tries to query an existing
            database.
            -->
            <input type="hidden" name="form_type" value="open_db">

            <!--
            Database selection:
            -------------------
            Users are able to select an existing database from a dropdown
            menu. The selected database is assigned to 'existing_db' which is
            processed in app.py.
            -->
            <select name="existing_db">
                {% for db in databases %}
                <option value="{{ db }}">{{ db }}</option>
                {% endfor %}
            </select>

            <!--
            "Open Selected Database" button redirects User to the query page
            where they can query the selected database.
            -->
            <button type="submit">Open Selected Database</button>
        </form>

    <!--
    If a database is not in the 'databases' folder, "No databases found yet.
    Upload one above!" appears.
    -->
    {% else %}
        <p><em>
            No databases found yet. Upload one above!
        </em></p>
    {% endif %}

    <hr>

    <!-- =====================================================================
         UPLOAD PRE-EXISTING DATABASE
         ===================================================================== -->
    <h2>Upload a Database to Query</h2>
    <form method="POST" enctype="multipart/form-data">

        <!--
        Hidden field used to denote the process of uploading a database into
        the 'databases' folder. 'upload_db' is used in app.py to determine
        which functions and commands are executed when the User tries to
        upload a database.
        -->
        <input type="hidden" name="form_type" value="upload_db">

        <!--
        Database upload:
        ----------------
        Allows the use of local databases that end in a .db file extension.
        File type restricted to prevent accidental uploads.
        -->
        <input type="file" name="database_file" accept=".db" required>

        <!--
        "Upload Database" button redirects User to the query page where
        they can query the database that they uploaded, if the upload was
        successful.
        -->
        <button type="submit">Upload Database</button>
    </form>

    <script>
        /*
        This script provides visual cues (spinner and loading message)
        that feedback to the User while variants are being loaded into a
        database, in the "Create or Add to a Database" section (denoted
        as 'make_database'.
        */
        const form = document.getElementById("make_database");
        const buttonSpinner = document.getElementById("buttonSpinner");
        const msg = document.getElementById("loadingMsg");

        form.addEventListener("submit", () => {
            buttonSpinner.style.display = "inline-block";
            msg.style.display = "block";            // show loading text
        });
    </script>

</body>
</html>
